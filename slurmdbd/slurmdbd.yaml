apiVersion: v1
kind: Namespace
metadata:
  name: slurm
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: slurmdbd
  namespace: slurm
spec:
  selector:
    matchLabels:
      app: slurmdbd
  template:
    metadata:
      labels:
        app: slurmdbd
    spec:
      containers:
      - name: slurmdbd
        image: rkhoja/slurm:slurmdbd
        imagePullPolicy: Always
        env:
        - name: STORAGE_HOST
          value: paice-db-pxc-db-haproxy.percona-db-cluster.svc.cluster.local # Percona cluster service name
        - name: STORAGE_PORT
          value: "3306"
        - name: STORAGE_USER
          value: root
        - name: STORAGE_PASS
          valueFrom:
            secretKeyRef:
              name: paice-db-pxc-db-secrets
              key: root
        - name: STORAGE_LOC
          value: "slurm_acct_db" 
        - name: AUTH_TYPE
          value: "auth/munge"
        volumeMounts:
        - name: munge-key
          mountPath: /etc/munge/.secret/
#        command: ["/bin/bash", "-c"]
#        args:
#          - |
#            tail -f /dev/null
      volumes:
      - name: munge-key
        secret:
          secretName: munge-key
          items:
          - key: munge-key
            path: munge.keyfile
      restartPolicy: Always
---
apiVersion: v1
kind: Service
metadata:
  name: slurmdbd-service
  namespace: slurm
  labels:
    app: slurmdbd-service
spec:
  allocateLoadBalancerNodePorts: true
  selector:
    app: slurmdbd
  ports:
  - name: 6819-6819
    port: 6819
    protocol: TCP
    targetPort: 6819
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800  # 3 hours
  type: LoadBalancer
  loadBalancerIP: 192.168.1.20
  externalTrafficPolicy: Cluster
  internalTrafficPolicy: Cluster
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
